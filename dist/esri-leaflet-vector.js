/* esri-leaflet-vector - v4.0.0 - Thu Sep 29 2022 12:37:56 GMT+0200 (Central European Summer Time)
 * Copyright (c) 2022 Environmental Systems Research Institute, Inc.
 * Apache-2.0 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("leaflet"),require("esri-leaflet"),require("maplibre-gl")):"function"==typeof define&&define.amd?define(["exports","leaflet","esri-leaflet","maplibre-gl"],i):i(((t="undefined"!=typeof globalThis?globalThis:t||self).L=t.L||{},t.L.esri=t.L.esri||{},t.L.esri.Vector={}),t.L,t.L.esri,t.maplibregl)}(this,(function(t,i,e,o){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=n(o);function a(t,i,e){/^https?:\/\//.test(t)&&/\/VectorTileServer\/?$/.test(t)?l(t,i,e):function(t,i,e){var o=i.portalUrl+"/sharing/rest/content/items/"+t+"/resources/styles/root.json";h(o,i,(function(n,s){p(t,i,n?function(t,o){t&&console.error(t),l(o.url,i,e)}:function(t,n){t&&console.error(t),r(n.url,i,(function(t,i){e(t,s,o,i,n.url)}))})}))}(t,i,e)}function r(t,i,o){var n=i.token?{token:i.token}:{};e.request(t,n,o)}function p(t,i,o){var n=i.token?{token:i.token}:{},s=i.portalUrl+"/sharing/rest/content/items/"+t;e.request(s,n,o)}function l(t,i,e){r(t,i,(function(o,n){o&&console.error(o);var s,a=t;"/"===t.charAt(t.length-1)&&(a=t.slice(0,t.length-1)),h(s="/"===n.defaultStyles.charAt(0)?a+n.defaultStyles+"/root.json":a+"/"+n.defaultStyles+"/root.json",i,(function(i,o){i&&console.error(i),e(null,o,s,n,t)}))}))}function h(t,i,o){var n=i.token?{token:i.token}:{};e.request(t,n,o)}function c(t,o){e.Support.cors&&e.request(t,{},(function(t,n){if(!t){o._esriAttributions=o._esriAttributions||[];for(var s=0;s<n.contributors.length;s++)for(var a=n.contributors[s],r=0;r<a.coverageAreas.length;r++){var p=a.coverageAreas[r],l=i.latLng(p.bbox[0],p.bbox[1]),h=i.latLng(p.bbox[2],p.bbox[3]);o._esriAttributions.push({attribution:a.attribution,score:p.score,bounds:i.latLngBounds(l,h),minZoom:p.zoomMin,maxZoom:p.zoomMax})}o._esriAttributions.sort((function(t,i){return i.score-t.score}));var c={target:o};e.Util._updateMapAttribution(c)}}))}const u=[3857,102100,102113];var m=i.Layer.extend({options:{updateInterval:32,padding:.1,interactive:!1,pane:"tilePane"},initialize:function(t){i.setOptions(this,t),this._throttledUpdate=i.Util.throttle(this._update,this.options.updateInterval,this)},onAdd:function(t){this._container||this._initContainer();var e=this.getPaneName();t.getPane(e).appendChild(this._container),this._initGL(),this._offset=this._map.containerPointToLayerPoint([0,0]),t.options.zoomAnimation&&i.DomEvent.on(t._proxy,i.DomUtil.TRANSITION_END,this._transitionEnd,this)},onRemove:function(t){this._map._proxy&&this._map.options.zoomAnimation&&i.DomEvent.off(this._map._proxy,i.DomUtil.TRANSITION_END,this._transitionEnd,this);var e=this.getPaneName();t.getPane(e).removeChild(this._container),this._glMap.remove(),this._glMap=null},getEvents:function(){return{move:this._throttledUpdate,zoomanim:this._animateZoom,zoom:this._pinchZoom,zoomstart:this._zoomStart,zoomend:this._zoomEnd,resize:this._resize}},getMaplibreMap:function(){return this._glMap},getCanvas:function(){return this._glMap.getCanvas()},getSize:function(){return this._map.getSize().multiplyBy(1+2*this.options.padding)},getOpacity:function(){return this.options.opacity},setOpacity:function(t){this.options.opacity=t,this._container.style.opacity=t},getBounds:function(){var t=this.getSize().multiplyBy(.5),e=this._map.latLngToContainerPoint(this._map.getCenter());return i.latLngBounds(this._map.containerPointToLatLng(e.subtract(t)),this._map.containerPointToLatLng(e.add(t)))},getContainer:function(){return this._container},getPaneName:function(){return this._map.getPane(this.options.pane)?this.options.pane:"tilePane"},_initContainer:function(){var t=this._container=i.DomUtil.create("div","leaflet-gl-layer"),e=this.getSize(),o=this._map.getSize().multiplyBy(this.options.padding);t.style.width=e.x+"px",t.style.height=e.y+"px";var n=this._map.containerPointToLayerPoint([0,0]).subtract(o);i.DomUtil.setPosition(t,n)},_initGL:function(){var t=this._map.getCenter(),e=i.extend({},this.options,{container:this._container,center:[t.lng,t.lat],zoom:this._map.getZoom()-1,attributionControl:!1});this._glMap=new s.default.Map(e),this._glMap.once("styledata",function(t){this.fire("styleLoaded")}.bind(this)),this._glMap.transform.latRange=null,this._glMap.transform.maxValidLatitude=1/0,this._transformGL(this._glMap),this._glMap._canvas.canvas?this._glMap._actualCanvas=this._glMap._canvas.canvas:this._glMap._actualCanvas=this._glMap._canvas;var o=this._glMap._actualCanvas;i.DomUtil.addClass(o,"leaflet-image-layer"),i.DomUtil.addClass(o,"leaflet-zoom-animated"),this.options.interactive&&i.DomUtil.addClass(o,"leaflet-interactive"),this.options.className&&i.DomUtil.addClass(o,this.options.className)},_update:function(t){if(this._offset=this._map.containerPointToLayerPoint([0,0]),!this._zooming){var e=this.getSize(),o=this._container,n=this._glMap,s=this._map.getSize().multiplyBy(this.options.padding),a=this._map.containerPointToLayerPoint([0,0]).subtract(s);i.DomUtil.setPosition(o,a),this._transformGL(n),n.transform.width!==e.x||n.transform.height!==e.y?(o.style.width=e.x+"px",o.style.height=e.y+"px",null!==n._resize&&void 0!==n._resize?n._resize():n.resize()):null!==n._update&&void 0!==n._update?n._update():n.update()}},_transformGL:function(t){var i=this._map.getCenter(),e=t.transform;e.center=s.default.LngLat.convert([i.lng,i.lat]),e.zoom=this._map.getZoom()-1},_pinchZoom:function(t){this._glMap.jumpTo({zoom:this._map.getZoom()-1,center:this._map.getCenter()})},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),o=this._map.getSize().multiplyBy(this.options.padding*e),n=this.getSize()._divideBy(2),s=this._map.project(t.center,t.zoom)._subtract(n)._add(this._map._getMapPanePos().add(o))._round(),a=this._map.project(this._map.getBounds().getNorthWest(),t.zoom)._subtract(s);i.DomUtil.setTransform(this._glMap._actualCanvas,a.subtract(this._offset),e)},_zoomStart:function(t){this._zooming=!0},_zoomEnd:function(){var t=this._map.getZoomScale(this._map.getZoom());i.DomUtil.setTransform(this._glMap._actualCanvas,null,t),this._zooming=!1,this._update()},_transitionEnd:function(t){i.Util.requestAnimFrame((function(){var t=this._map.getZoom(),e=this._map.getCenter(),o=this._map.latLngToContainerPoint(this._map.getBounds().getNorthWest());i.DomUtil.setTransform(this._glMap._actualCanvas,o,1),this._glMap.once("moveend",i.Util.bind((function(){this._zoomEnd()}),this)),this._glMap.jumpTo({center:e,zoom:t-1})}),this)}});function _(t){return new m(t)}var d=i.Layer.extend({options:{key:"ArcGIS:Streets"},initialize:function(t,e){if(e&&i.setOptions(this,e),this.options.apiKey&&(this.options.apikey=this.options.apiKey),this.options.token&&(this.options.apikey=this.options.token),!this.options.apikey&&!this.options.token)throw new Error("API Key or token is required for vectorBasemapLayer.");t&&(this.options.key=t),this._createLayer()},_createLayer:function(){var t,i,e,o,n=(t=this.options.key,i=this.options.apikey,e=this.options.customUrl,o=e||"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/"+t+"?type=style",i&&(o=o+"&apiKey="+i),o);this._maplibreGL=_({style:n,pane:this.options.pane,opacity:this.options.opacity}),this._ready=!0,this.fire("ready",{},!0),this._maplibreGL.on("styleLoaded",function(t){this._setupAttribution()}.bind(this))},_setupAttribution:function(){var t=this._map;if(e.Util.setEsriAttribution(t),32===this.options.key.length){var i=this._maplibreGL.getMaplibreMap().style.stylesheet.sources,o=[];Object.keys(i).forEach((function(t){o.push(i[t].attribution),i[t].copyrightText&&i[t].copyrightText&&""!==i[t].copyrightText&&i[t].attribution!==i[t].copyrightText&&o.push(i[t].copyrightText)})),t.attributionControl.addAttribution('<span class="">'+o.join(", ")+"</span>")}else if(this.options.attributionUrls||(this.options.attributionUrls=this._getAttributionUrls(this.options.key)),this._map&&this.options.attributionUrls){if(this._map.attributionControl){for(let i=0;i<this.options.attributionUrls.length;i++){c(this.options.attributionUrls[i],t)}t.attributionControl.addAttribution('<span class="esri-dynamic-attribution"></span>')}e.Util._updateMapAttribution({target:this._map})}},_getAttributionUrls:function(t){return 0===t.indexOf("OSM:")?["https://static.arcgis.com/attribution/Vector/OpenStreetMap_v2"]:0===t.indexOf("ArcGIS:Imagery")?["https://static.arcgis.com/attribution/World_Imagery","https://static.arcgis.com/attribution/Vector/World_Basemap_v2"]:["https://static.arcgis.com/attribution/Vector/World_Basemap_v2"]},onAdd:function(t){this._map=t,this._initPane(),this._ready?this._asyncAdd():this.once("ready",(function(){this._asyncAdd()}),this)},_initPane:function(){if(this.options.pane||(this.options.key.indexOf(":Labels")>-1?this.options.pane="esri-labels":this.options.pane="tilePane"),!this._map.getPane(this.options.pane)){var t=this._map.createPane(this.options.pane);t.style.pointerEvents="none",t.style.zIndex="esri-labels"===this.options.pane?550:500}},onRemove:function(t){if(t.off("moveend",e.Util._updateMapAttribution),t.removeLayer(this._maplibreGL),t.attributionControl){var i=document.getElementsByClassName("esri-dynamic-attribution");if(i&&i.length>0){var o=i[0].outerHTML;t.attributionControl.removeAttribution(o)}}},_asyncAdd:function(){var t=this._map;t.on("moveend",e.Util._updateMapAttribution),this._maplibreGL.addTo(t,this)}});var f=i.Layer.extend({options:{pane:"overlayPane",portalUrl:"https://www.arcgis.com"},initialize:function(t,e){if(e&&i.setOptions(this,e),this.options.apiKey&&(this.options.apikey=this.options.apiKey),this.options.apikey&&(this.options.token=this.options.apikey),!t)throw new Error("An ITEM ID or SERVICE URL is required for vectorTileLayer.");t&&(this.options.key=t),this._createLayer()},_createLayer:function(){a(this.options.key,this.options,function(t,i,e,o){if(t)throw new Error(t);var n;if(n=o.tileInfo.spatialReference.wkid,u.indexOf(n)>=0||console.warn('This layer is not guaranteed to display properly because its service does not use the Web Mercator projection. The "tileInfo.spatialReference" property is:',o.tileInfo.spatialReference,"\nMore information is available at https://github.com/maplibre/maplibre-gl-js/issues/168 and https://github.com/Esri/esri-leaflet-vector/issues/94."),i=function(t,i,e,o){for(var n=Object.keys(t.sources),s=0;s<n.length;s++){var a=t.sources[n[s]];-1===a.url.indexOf("http")&&(a.url=i.replace("/resources/styles/root.json","")),"/"===a.url.charAt(a.url.length-1)&&(a.url=a.url.slice(0,a.url.length-1)),a.tiles||(e.tiles&&"/"!==e.tiles[0].charAt(0)&&(e.tiles[0]="/"+e.tiles[0]),a.tiles=[a.url+e.tiles[0]]),a.url+="?f=json",a.url+=o?"&token="+o:"",a.tiles[0]+=o?"?token="+o:"",a.minzoom=e.tileInfo.lods[0].level,a.maxzoom=e.tileInfo.lods[e.tileInfo.lods.length-1].level}var r=t.sources[n[n.length-1]];r.attribution=e.copyrightText||"",r.copyrightText=e.copyrightText||"";for(var p=0;p<t.layers.length;p++){var l=t.layers[p];l.layout&&l.layout["text-font"]&&l.layout["text-font"].length>1&&(l.layout["text-font"]=[l.layout["text-font"][0]])}return t.sprite&&-1===t.sprite.indexOf("http")&&(t.sprite=i.replace("styles/root.json",t.sprite.replace("../","")),t.sprite+=o?"?token="+o:""),t.glyphs&&-1===t.glyphs.indexOf("http")&&(t.glyphs=i.replace("styles/root.json",t.glyphs.replace("../","")),t.glyphs+=o?"?token="+o:""),t}(i,e,o,this.options.token),!this.getAttribution()){var s=Object.keys(i.sources);this.options.attribution=i.sources[s[s.length-1]].attribution,this._map&&this._map.attributionControl&&this._map.attributionControl.addAttribution(this.getAttribution())}this.options.style&&"function"==typeof this.options.style&&(i=this.options.style(i)),this._maplibreGL=_({style:i,pane:this.options.pane,opacity:this.options.opacity}),this._ready=!0,this.fire("ready",{},!0)}.bind(this))},onAdd:function(t){this._map=t,this._ready?this._asyncAdd():this.once("ready",(function(){this._asyncAdd()}),this)},onRemove:function(t){t.removeLayer(this._maplibreGL)},_asyncAdd:function(){var t=this._map;this._maplibreGL.addTo(t,this)}});t.VERSION="4.0.0",t.VectorBasemapLayer=d,t.VectorTileLayer=f,t.vectorBasemapLayer=function(t,i){return new d(t,i)},t.vectorTileLayer=function(t,i){return new f(t,i)},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=esri-leaflet-vector.js.map
