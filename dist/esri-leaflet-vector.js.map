{"version":3,"file":"esri-leaflet-vector.js","sources":["../src/Util.js","../src/MaplibreGLLayer.js","../src/VectorBasemapLayer.js","../src/VectorTileLayer.js"],"sourcesContent":["import { latLng, latLngBounds } from 'leaflet';\nimport { request, Support, Util } from 'esri-leaflet';\n\n/*\n  utility to establish a URL for the basemap styles API\n  used primarily by VectorBasemapLayer.js\n*/\nexport function getBasemapStyleUrl (key, apikey, customUrl) {\n  var url = customUrl || 'https://basemaps-api.arcgis.com/arcgis/rest/services/styles/' + key + '?type=style';\n  if (apikey) {\n    url = url + '&apiKey=' + apikey;\n  }\n  return url;\n}\n\n/*\n  utilities to communicate with custom user styles via an ITEM ID or SERVICE URL\n  used primarily by VectorTileLayer.js\n*/\nexport function loadStyle (idOrUrl, options, callback) {\n  var httpRegex = /^https?:\\/\\//;\n  var serviceRegex = /\\/VectorTileServer\\/?$/;\n\n  if (httpRegex.test(idOrUrl) && serviceRegex.test(idOrUrl)) {\n    var serviceUrl = idOrUrl;\n    loadStyleFromService(serviceUrl, options, callback);\n  } else {\n    var itemId = idOrUrl;\n    loadStyleFromItem(itemId, options, callback);\n  }\n}\n\nexport function loadService (serviceUrl, options, callback) {\n  var params = options.token ? { token: options.token } : {};\n  request(serviceUrl, params, callback);\n}\n\nfunction loadItem (itemId, options, callback) {\n  var params = options.token ? { token: options.token } : {};\n  var url = options.portalUrl +\n    '/sharing/rest/content/items/' +\n    itemId;\n  request(url, params, callback);\n}\n\nfunction loadStyleFromItem (itemId, options, callback) {\n  var itemStyleUrl =\n    options.portalUrl +\n    '/sharing/rest/content/items/' +\n    itemId +\n    '/resources/styles/root.json';\n\n  loadStyleFromUrl(itemStyleUrl, options, function (error, style) {\n    if (error) {\n      loadItem(itemId, options, function (error, item) {\n        if (error) {\n          console.error(error);\n        }\n        loadStyleFromService(item.url, options, callback);\n      });\n    } else {\n      loadItem(itemId, options, function (error, item) {\n        if (error) {\n          console.error(error);\n        }\n        loadService(item.url, options, function (error, service) {\n          callback(error, style, itemStyleUrl, service, item.url);\n        });\n      });\n    }\n  });\n}\n\nfunction loadStyleFromService (serviceUrl, options, callback) {\n  loadService(serviceUrl, options, function (error, service) {\n    if (error) {\n      console.error(error);\n    }\n\n    var sanitizedServiceUrl = serviceUrl;\n    // a trailing \"/\" may create invalid paths\n    if (serviceUrl.charAt(serviceUrl.length - 1) === '/') {\n      sanitizedServiceUrl = serviceUrl.slice(0, serviceUrl.length - 1);\n    }\n\n    var defaultStylesUrl;\n    // inadvertently inserting more than 1 adjacent \"/\" may create invalid paths\n    if (service.defaultStyles.charAt(0) === '/') {\n      defaultStylesUrl =\n        sanitizedServiceUrl + service.defaultStyles + '/root.json';\n    } else {\n      defaultStylesUrl =\n        sanitizedServiceUrl + '/' + service.defaultStyles + '/root.json';\n    }\n\n    loadStyleFromUrl(defaultStylesUrl, options, function (error, style) {\n      if (error) {\n        console.error(error);\n      }\n      callback(null, style, defaultStylesUrl, service, serviceUrl);\n    });\n  });\n}\n\nfunction loadStyleFromUrl (styleUrl, options, callback) {\n  var params = options.token ? { token: options.token } : {};\n  request(styleUrl, params, callback);\n}\n\nexport function formatStyle (style, styleUrl, metadata, token) {\n  // transforms style object in place and also returns it\n\n  // modify each source in style.sources\n  var sourcesKeys = Object.keys(style.sources);\n  for (var sourceIndex = 0; sourceIndex < sourcesKeys.length; sourceIndex++) {\n    var source = style.sources[sourcesKeys[sourceIndex]];\n\n    // if a relative path is referenced, the default style can be found in a standard location\n    if (source.url.indexOf('http') === -1) {\n      source.url = styleUrl.replace('/resources/styles/root.json', '');\n    }\n\n    // a trailing \"/\" may create invalid paths\n    if (source.url.charAt(source.url.length - 1) === '/') {\n      source.url = source.url.slice(0, source.url.length - 1);\n    }\n\n    // add tiles property if missing\n    if (!source.tiles) {\n      // right now ArcGIS Pro published vector services have a slightly different signature\n      // the '/' is needed in the URL string concatenation below for source.tiles\n      if (metadata.tiles && metadata.tiles[0].charAt(0) !== '/') {\n        metadata.tiles[0] = '/' + metadata.tiles[0];\n      }\n\n      source.tiles = [source.url + metadata.tiles[0]];\n    }\n\n    // some VectorTileServer endpoints may default to returning f=html,\n    // specify f=json to account for that behavior\n    source.url += '?f=json';\n\n    // add the token to the source url and tiles properties as a query param\n    source.url += token ? '&token=' + token : '';\n    source.tiles[0] += token ? '?token=' + token : '';\n\n    // add minzoom and maxzoom to each source based on the service metadata\n    source.minzoom = metadata.tileInfo.lods[0].level;\n    source.maxzoom =\n      metadata.tileInfo.lods[metadata.tileInfo.lods.length - 1].level;\n  }\n\n  // add the attribution and copyrightText properties to the last source in style.sources based on the service metadata\n  var lastSource = style.sources[sourcesKeys[sourcesKeys.length - 1]];\n  lastSource.attribution = metadata.copyrightText || '';\n  lastSource.copyrightText = metadata.copyrightText || '';\n\n  // if any layer in style.layers has a layout.text-font property (it will be any array of strings) remove all items in the array after the first\n  for (var layerIndex = 0; layerIndex < style.layers.length; layerIndex++) {\n    var layer = style.layers[layerIndex];\n    if (\n      layer.layout &&\n      layer.layout['text-font'] &&\n      layer.layout['text-font'].length > 1\n    ) {\n      layer.layout['text-font'] = [layer.layout['text-font'][0]];\n    }\n  }\n\n  if (style.sprite && style.sprite.indexOf('http') === -1) {\n    // resolve absolute URL for style.sprite\n    style.sprite = styleUrl.replace(\n      'styles/root.json',\n      style.sprite.replace('../', '')\n    );\n\n    // add the token to the style.sprite property as a query param\n    style.sprite += token ? '?token=' + token : '';\n  }\n\n  if (style.glyphs && style.glyphs.indexOf('http') === -1) {\n    // resolve absolute URL for style.glyphs\n    style.glyphs = styleUrl.replace(\n      'styles/root.json',\n      style.glyphs.replace('../', '')\n    );\n\n    // add the token to the style.glyphs property as a query param\n    style.glyphs += token ? '?token=' + token : '';\n  }\n\n  return style;\n}\n\n/*\n  utility to assist with dynamic attribution data\n  used primarily by VectorBasemapLayer.js\n*/\nexport function getAttributionData (url, map) {\n  if (Support.cors) {\n    request(url, {}, function (error, attributions) {\n      if (error) {\n        return;\n      }\n      map._esriAttributions = map._esriAttributions || [];\n      for (var c = 0; c < attributions.contributors.length; c++) {\n        var contributor = attributions.contributors[c];\n\n        for (var i = 0; i < contributor.coverageAreas.length; i++) {\n          var coverageArea = contributor.coverageAreas[i];\n          var southWest = latLng(coverageArea.bbox[0], coverageArea.bbox[1]);\n          var northEast = latLng(coverageArea.bbox[2], coverageArea.bbox[3]);\n          map._esriAttributions.push({\n            attribution: contributor.attribution,\n            score: coverageArea.score,\n            bounds: latLngBounds(southWest, northEast),\n            minZoom: coverageArea.zoomMin,\n            maxZoom: coverageArea.zoomMax\n          });\n        }\n      }\n\n      map._esriAttributions.sort(function (a, b) {\n        return b.score - a.score;\n      });\n\n      // pass the same argument as the map's 'moveend' event\n      var obj = { target: map };\n      Util._updateMapAttribution(obj);\n    });\n  }\n}\n\n/*\n  utility to check if a service's tileInfo spatial reference is in Web Mercator\n  used primarily by VectorTileLayer.js\n*/\nconst WEB_MERCATOR_WKIDS = [3857, 102100, 102113];\n\nexport function isWebMercator (wkid) {\n  return WEB_MERCATOR_WKIDS.indexOf(wkid) >= 0;\n}\n","import {\n  DomEvent,\n  DomUtil,\n  extend,\n  latLngBounds,\n  Layer,\n  setOptions,\n  Util\n} from 'leaflet';\nimport maplibregl from 'maplibre-gl';\n\nexport var MaplibreGLJSLayer = Layer.extend({\n  options: {\n    updateInterval: 32,\n    // How much to extend the overlay view (relative to map size)\n    // e.g. 0.1 would be 10% of map view in each direction\n    padding: 0.1,\n    // whether or not to register the mouse and keyboard\n    // events on the mapbox overlay\n    interactive: false,\n    // set the tilepane as the default pane to draw gl tiles\n    pane: 'tilePane'\n  },\n\n  initialize: function (options) {\n    setOptions(this, options);\n\n    // setup throttling the update event when panning\n    this._throttledUpdate = Util.throttle(\n      this._update,\n      this.options.updateInterval,\n      this\n    );\n  },\n\n  onAdd: function (map) {\n    if (!this._container) {\n      this._initContainer();\n    }\n\n    var paneName = this.getPaneName();\n    map.getPane(paneName).appendChild(this._container);\n\n    this._initGL();\n\n    this._offset = this._map.containerPointToLayerPoint([0, 0]);\n\n    // work around https://github.com/mapbox/mapbox-gl-leaflet/issues/47\n    if (map.options.zoomAnimation) {\n      DomEvent.on(\n        map._proxy,\n        DomUtil.TRANSITION_END,\n        this._transitionEnd,\n        this\n      );\n    }\n  },\n\n  onRemove: function (map) {\n    if (this._map._proxy && this._map.options.zoomAnimation) {\n      DomEvent.off(\n        this._map._proxy,\n        DomUtil.TRANSITION_END,\n        this._transitionEnd,\n        this\n      );\n    }\n\n    var paneName = this.getPaneName();\n    map.getPane(paneName).removeChild(this._container);\n\n    this._glMap.remove();\n    this._glMap = null;\n  },\n\n  getEvents: function () {\n    return {\n      move: this._throttledUpdate, // sensibly throttle updating while panning\n      zoomanim: this._animateZoom, // applys the zoom animation to the <canvas>\n      zoom: this._pinchZoom, // animate every zoom event for smoother pinch-zooming\n      zoomstart: this._zoomStart, // flag starting a zoom to disable panning\n      zoomend: this._zoomEnd,\n      resize: this._resize\n    };\n  },\n\n  getMaplibreMap: function () {\n    return this._glMap;\n  },\n\n  getCanvas: function () {\n    return this._glMap.getCanvas();\n  },\n\n  getSize: function () {\n    return this._map.getSize().multiplyBy(1 + this.options.padding * 2);\n  },\n\n  getOpacity: function () {\n    return this.options.opacity;\n  },\n\n  setOpacity: function (opacity) {\n    this.options.opacity = opacity;\n    this._container.style.opacity = opacity;\n  },\n\n  getBounds: function () {\n    var halfSize = this.getSize().multiplyBy(0.5);\n    var center = this._map.latLngToContainerPoint(this._map.getCenter());\n    return latLngBounds(\n      this._map.containerPointToLatLng(center.subtract(halfSize)),\n      this._map.containerPointToLatLng(center.add(halfSize))\n    );\n  },\n\n  getContainer: function () {\n    return this._container;\n  },\n\n  // returns the pane name set in options if it is a valid pane, defaults to tilePane\n  getPaneName: function () {\n    return this._map.getPane(this.options.pane) ? this.options.pane : 'tilePane';\n  },\n\n  _initContainer: function () {\n    var container = (this._container = DomUtil.create(\n      'div',\n      'leaflet-gl-layer'\n    ));\n\n    var size = this.getSize();\n    var offset = this._map.getSize().multiplyBy(this.options.padding);\n    container.style.width = size.x + 'px';\n    container.style.height = size.y + 'px';\n\n    var topLeft = this._map.containerPointToLayerPoint([0, 0]).subtract(offset);\n\n    DomUtil.setPosition(container, topLeft);\n  },\n\n  _initGL: function () {\n    var center = this._map.getCenter();\n\n    var options = extend({}, this.options, {\n      container: this._container,\n      center: [center.lng, center.lat],\n      zoom: this._map.getZoom() - 1,\n      attributionControl: false\n    });\n\n    this._glMap = new maplibregl.Map(options);\n\n    // Fire event for Maplibre \"styledata\" event.\n    this._glMap.once('styledata', function (res) {\n      this.fire('styleLoaded');\n    }.bind(this));\n\n    // allow GL base map to pan beyond min/max latitudes\n    this._glMap.transform.latRange = null;\n    this._glMap.transform.maxValidLatitude = Infinity;\n\n    this._transformGL(this._glMap);\n\n    if (this._glMap._canvas.canvas) {\n      // older versions of mapbox-gl surfaced the canvas differently\n      this._glMap._actualCanvas = this._glMap._canvas.canvas;\n    } else {\n      this._glMap._actualCanvas = this._glMap._canvas;\n    }\n\n    // treat child <canvas> element like L.ImageOverlay\n    var canvas = this._glMap._actualCanvas;\n    DomUtil.addClass(canvas, 'leaflet-image-layer');\n    DomUtil.addClass(canvas, 'leaflet-zoom-animated');\n    if (this.options.interactive) {\n      DomUtil.addClass(canvas, 'leaflet-interactive');\n    }\n    if (this.options.className) {\n      DomUtil.addClass(canvas, this.options.className);\n    }\n  },\n\n  _update: function (e) {\n    // update the offset so we can correct for it later when we zoom\n    this._offset = this._map.containerPointToLayerPoint([0, 0]);\n\n    if (this._zooming) {\n      return;\n    }\n\n    var size = this.getSize();\n    var container = this._container;\n    var gl = this._glMap;\n    var offset = this._map.getSize().multiplyBy(this.options.padding);\n    var topLeft = this._map.containerPointToLayerPoint([0, 0]).subtract(offset);\n\n    DomUtil.setPosition(container, topLeft);\n\n    this._transformGL(gl);\n\n    if (gl.transform.width !== size.x || gl.transform.height !== size.y) {\n      container.style.width = size.x + 'px';\n      container.style.height = size.y + 'px';\n      if (gl._resize !== null && gl._resize !== undefined) {\n        gl._resize();\n      } else {\n        gl.resize();\n      }\n    } else {\n      // older versions of mapbox-gl surfaced update publicly\n      if (gl._update !== null && gl._update !== undefined) {\n        gl._update();\n      } else {\n        gl.update();\n      }\n    }\n  },\n\n  _transformGL: function (gl) {\n    var center = this._map.getCenter();\n\n    // gl.setView([center.lat, center.lng], this._map.getZoom() - 1, 0);\n    // calling setView directly causes sync issues because it uses requestAnimFrame\n\n    var tr = gl.transform;\n    tr.center = maplibregl.LngLat.convert([center.lng, center.lat]);\n    tr.zoom = this._map.getZoom() - 1;\n  },\n\n  // update the map constantly during a pinch zoom\n  _pinchZoom: function (e) {\n    this._glMap.jumpTo({\n      zoom: this._map.getZoom() - 1,\n      center: this._map.getCenter()\n    });\n  },\n\n  // borrowed from L.ImageOverlay\n  // https://github.com/Leaflet/Leaflet/blob/master/src/layer/ImageOverlay.js#L139-L144\n  _animateZoom: function (e) {\n    var scale = this._map.getZoomScale(e.zoom);\n    var padding = this._map.getSize().multiplyBy(this.options.padding * scale);\n    var viewHalf = this.getSize()._divideBy(2);\n    // corrections for padding (scaled), adapted from\n    // https://github.com/Leaflet/Leaflet/blob/master/src/map/Map.js#L1490-L1508\n    var topLeft = this._map\n      .project(e.center, e.zoom)\n      ._subtract(viewHalf)\n      ._add(this._map._getMapPanePos().add(padding))\n      ._round();\n    var offset = this._map\n      .project(this._map.getBounds().getNorthWest(), e.zoom)\n      ._subtract(topLeft);\n\n    DomUtil.setTransform(\n      this._glMap._actualCanvas,\n      offset.subtract(this._offset),\n      scale\n    );\n  },\n\n  _zoomStart: function (e) {\n    this._zooming = true;\n  },\n\n  _zoomEnd: function () {\n    var scale = this._map.getZoomScale(this._map.getZoom());\n\n    DomUtil.setTransform(\n      this._glMap._actualCanvas,\n      null,\n      scale\n    );\n\n    this._zooming = false;\n\n    this._update();\n  },\n\n  _transitionEnd: function (e) {\n    Util.requestAnimFrame(function () {\n      var zoom = this._map.getZoom();\n      var center = this._map.getCenter();\n      var offset = this._map.latLngToContainerPoint(\n        this._map.getBounds().getNorthWest()\n      );\n\n      // reset the scale and offset\n      DomUtil.setTransform(this._glMap._actualCanvas, offset, 1);\n\n      // enable panning once the gl map is ready again\n      this._glMap.once(\n        'moveend',\n        Util.bind(function () {\n          this._zoomEnd();\n        }, this)\n      );\n\n      // update the map position\n      this._glMap.jumpTo({\n        center: center,\n        zoom: zoom - 1\n      });\n    }, this);\n  }\n});\n\nexport function maplibreGLJSLayer (options) {\n  return new MaplibreGLJSLayer(options);\n}\n","import { Layer, setOptions } from 'leaflet';\nimport { Util } from 'esri-leaflet';\nimport { getBasemapStyleUrl, getAttributionData } from './Util';\nimport { maplibreGLJSLayer } from './MaplibreGLLayer';\n\nexport var VectorBasemapLayer = Layer.extend({\n  options: {\n    key: 'ArcGIS:Streets' // default style key enum if none provided\n  },\n\n  /**\n   * Populates \"this.options\" to be used in the rest of the module.\n   *\n   * @param {string} key\n   * @param {object} options optional\n   */\n  initialize: function (key, options) {\n    if (options) {\n      setOptions(this, options);\n    }\n\n    // support outdated casing apiKey of apikey\n    if (this.options.apiKey) {\n      this.options.apikey = this.options.apiKey;\n    }\n\n    // if token is passed in, use it as an apiKey\n    if (this.options.token) {\n      this.options.apikey = this.options.token;\n    }\n\n    // If no API Key or token is required:\n    if (!(this.options.apikey || this.options.token)) {\n      throw new Error('API Key or token is required for vectorBasemapLayer.');\n    }\n\n    // set key onto \"this.options\" for use elsewhere in the module.\n    if (key) {\n      this.options.key = key;\n    }\n\n    // this.options has been set, continue on to create the layer:\n    this._createLayer();\n  },\n\n  /**\n   * Creates the maplibreGLJSLayer given using \"this.options\"\n   */\n  _createLayer: function () {\n    var styleUrl = getBasemapStyleUrl(this.options.key, this.options.apikey, this.options.customUrl);\n\n    this._maplibreGL = maplibreGLJSLayer({\n      style: styleUrl,\n      pane: this.options.pane,\n      opacity: this.options.opacity\n    });\n\n    this._ready = true;\n    this.fire('ready', {}, true);\n\n    this._maplibreGL.on('styleLoaded', function (res) {\n      this._setupAttribution();\n    }.bind(this));\n  },\n\n  _setupAttribution: function () {\n    var map = this._map;\n    // Set attribution\n    Util.setEsriAttribution(map);\n\n    if (this.options.key.length === 32) {\n      // this is an itemId\n      var sources = this._maplibreGL.getMaplibreMap().style.stylesheet.sources;\n      var allAttributions = [];\n      Object.keys(sources).forEach(function (key) {\n        allAttributions.push(sources[key].attribution);\n        if (sources[key].copyrightText && sources[key].copyrightText && sources[key].copyrightText !== '' && sources[key].attribution !== sources[key].copyrightText) {\n          allAttributions.push(sources[key].copyrightText);\n        }\n      });\n\n      map.attributionControl.addAttribution('<span class=\"\">' + allAttributions.join(', ') + '</span>');\n    } else {\n      // this is an enum\n      if (!this.options.attributionUrls) {\n        this.options.attributionUrls = this._getAttributionUrls(this.options.key);\n      }\n\n      if (this._map && this.options.attributionUrls) {\n        if (this._map.attributionControl) {\n          for (\n            let index = 0;\n            index < this.options.attributionUrls.length;\n            index++\n          ) {\n            const attributionUrl = this.options.attributionUrls[index];\n            getAttributionData(attributionUrl, map);\n          }\n\n          map.attributionControl.addAttribution(\n            '<span class=\"esri-dynamic-attribution\"></span>'\n          );\n        }\n        Util._updateMapAttribution({ target: this._map });\n      }\n    }\n  },\n\n  /**\n   * Given a key, return the attribution url(s).\n   * @param {string} key\n   */\n  _getAttributionUrls: function (key) {\n    if (key.indexOf('OSM:') === 0) {\n      return ['https://static.arcgis.com/attribution/Vector/OpenStreetMap_v2'];\n    } else if (key.indexOf('ArcGIS:Imagery') === 0) {\n      return [\n        'https://static.arcgis.com/attribution/World_Imagery',\n        'https://static.arcgis.com/attribution/Vector/World_Basemap_v2'\n      ];\n    }\n\n    // default:\n    return ['https://static.arcgis.com/attribution/Vector/World_Basemap_v2'];\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n\n    this._initPane();\n\n    if (this._ready) {\n      this._asyncAdd();\n    } else {\n      this.once(\n        'ready',\n        function () {\n          this._asyncAdd();\n        },\n        this\n      );\n    }\n  },\n\n  _initPane: function () {\n    // if the layer is a \"label\" layer, should use the \"esri-label\" pane.\n    if (!this.options.pane) {\n      if (this.options.key.indexOf(':Labels') > -1) {\n        this.options.pane = 'esri-labels';\n      } else {\n        this.options.pane = 'tilePane';\n      }\n    }\n\n    if (!this._map.getPane(this.options.pane)) {\n      var pane = this._map.createPane(this.options.pane);\n      pane.style.pointerEvents = 'none';\n      pane.style.zIndex = this.options.pane === 'esri-labels' ? 550 : 500;\n    }\n  },\n\n  onRemove: function (map) {\n    map.off('moveend', Util._updateMapAttribution);\n    map.removeLayer(this._maplibreGL);\n\n    if (map.attributionControl) {\n      var element = document.getElementsByClassName('esri-dynamic-attribution');\n\n      if (element && element.length > 0) {\n        var vectorAttribution = element[0].outerHTML;\n        // this doesn't work, not sure why.\n        map.attributionControl.removeAttribution(vectorAttribution);\n      }\n    }\n  },\n\n  _asyncAdd: function () {\n    var map = this._map;\n    map.on('moveend', Util._updateMapAttribution);\n    this._maplibreGL.addTo(map, this);\n  }\n});\n\nexport function vectorBasemapLayer (key, options) {\n  return new VectorBasemapLayer(key, options);\n}\n\nexport default vectorBasemapLayer;\n","import { Layer, setOptions } from 'leaflet';\nimport { loadStyle, formatStyle, isWebMercator } from './Util';\nimport { maplibreGLJSLayer } from './MaplibreGLLayer';\n\nexport var VectorTileLayer = Layer.extend({\n  options: {\n    // if pane is not provided, default to LeafletJS's overlayPane\n    // https://leafletjs.com/reference.html#map-pane\n    pane: 'overlayPane',\n\n    // if portalUrl is not provided, default to ArcGIS Online\n    portalUrl: 'https://www.arcgis.com'\n  },\n\n  /**\n   * Populates \"this.options\" to be used in the rest of the module and creates the layer instance.\n   *\n   * @param {string} key an ITEM ID or SERVICE URL\n   * @param {object} options optional\n   */\n  initialize: function (key, options) {\n    if (options) {\n      setOptions(this, options);\n    }\n\n    // support outdated casing apiKey of apikey\n    if (this.options.apiKey) {\n      this.options.apikey = this.options.apiKey;\n    }\n\n    // if apiKey is passed in, use it as a token\n    // (opposite from VectorBasemapLayer.js)\n    if (this.options.apikey) {\n      this.options.token = this.options.apikey;\n    }\n\n    // if no key passed in\n    if (!key) {\n      throw new Error('An ITEM ID or SERVICE URL is required for vectorTileLayer.');\n    }\n\n    // set key onto \"this.options\" for use elsewhere in the module.\n    if (key) {\n      this.options.key = key;\n    }\n\n    // this.options has been set, continue on to create the layer:\n    this._createLayer();\n  },\n\n  /**\n   * Creates the maplibreGLJSLayer given using \"this.options\"\n   */\n  _createLayer: function () {\n    loadStyle(\n      this.options.key,\n      this.options,\n      function (error, style, styleUrl, service) {\n        if (error) {\n          throw new Error(error);\n        }\n\n        if (!isWebMercator(service.tileInfo.spatialReference.wkid)) {\n          console.warn(\n            'This layer is not guaranteed to display properly because its service does not use the Web Mercator projection. The \"tileInfo.spatialReference\" property is:',\n            service.tileInfo.spatialReference,\n            '\\nMore information is available at https://github.com/maplibre/maplibre-gl-js/issues/168 and https://github.com/Esri/esri-leaflet-vector/issues/94.'\n          );\n        }\n\n        // once style object is loaded it must be transformed to be compliant with maplibreGLJSLayer\n        style = formatStyle(style, styleUrl, service, this.options.token);\n\n        // if a custom attribution was not provided in the options,\n        // then attempt to rely on the attribution of the last source in the style object\n        // and add it to the map's attribution control\n        // (otherwise it would have already been added by leaflet to the attribution control)\n        if (!this.getAttribution()) {\n          var sourcesKeys = Object.keys(style.sources);\n          this.options.attribution = style.sources[sourcesKeys[sourcesKeys.length - 1]].attribution;\n          if (this._map && this._map.attributionControl) {\n            // NOTE: if attribution is an empty string (or otherwise falsy) at this point it would not appear in the attribution control\n            this._map.attributionControl.addAttribution(this.getAttribution());\n          }\n        }\n\n        // additionally modify the style object with the user's optional style override function\n        if (this.options.style && typeof this.options.style === 'function') {\n          style = this.options.style(style);\n        }\n\n        this._maplibreGL = maplibreGLJSLayer({\n          style: style,\n          pane: this.options.pane,\n          opacity: this.options.opacity\n        });\n\n        this._ready = true;\n        this.fire('ready', {}, true);\n      }.bind(this)\n    );\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n\n    if (this._ready) {\n      this._asyncAdd();\n    } else {\n      this.once(\n        'ready',\n        function () {\n          this._asyncAdd();\n        },\n        this\n      );\n    }\n  },\n\n  onRemove: function (map) {\n    map.removeLayer(this._maplibreGL);\n  },\n\n  _asyncAdd: function () {\n    var map = this._map;\n    this._maplibreGL.addTo(map, this);\n  }\n});\n\nexport function vectorTileLayer (key, options) {\n  return new VectorTileLayer(key, options);\n}\n\nexport default vectorTileLayer;\n"],"names":["loadStyle","idOrUrl","options","callback","test","loadStyleFromService","itemId","itemStyleUrl","portalUrl","loadStyleFromUrl","error","style","loadItem","item","console","url","loadService","service","loadStyleFromItem","serviceUrl","params","token","request","defaultStylesUrl","sanitizedServiceUrl","charAt","length","slice","defaultStyles","styleUrl","getAttributionData","map","Support","cors","attributions","_esriAttributions","c","contributors","contributor","i","coverageAreas","coverageArea","southWest","latLng","bbox","northEast","push","attribution","score","bounds","latLngBounds","minZoom","zoomMin","maxZoom","zoomMax","sort","a","b","obj","target","Util","_updateMapAttribution","WEB_MERCATOR_WKIDS","MaplibreGLJSLayer","Layer","extend","updateInterval","padding","interactive","pane","initialize","setOptions","this","_throttledUpdate","throttle","_update","onAdd","_container","_initContainer","paneName","getPaneName","getPane","appendChild","_initGL","_offset","_map","containerPointToLayerPoint","zoomAnimation","DomEvent","on","_proxy","DomUtil","TRANSITION_END","_transitionEnd","onRemove","off","removeChild","_glMap","remove","getEvents","move","zoomanim","_animateZoom","zoom","_pinchZoom","zoomstart","_zoomStart","zoomend","_zoomEnd","resize","_resize","getMaplibreMap","getCanvas","getSize","multiplyBy","getOpacity","opacity","setOpacity","getBounds","halfSize","center","latLngToContainerPoint","getCenter","containerPointToLatLng","subtract","add","getContainer","container","create","size","offset","width","x","height","y","topLeft","setPosition","lng","lat","getZoom","attributionControl","maplibregl","Map","once","res","fire","bind","transform","latRange","maxValidLatitude","Infinity","_transformGL","_canvas","canvas","_actualCanvas","addClass","className","e","_zooming","gl","undefined","update","tr","LngLat","convert","jumpTo","scale","getZoomScale","viewHalf","_divideBy","project","_subtract","_add","_getMapPanePos","_round","getNorthWest","setTransform","requestAnimFrame","maplibreGLJSLayer","VectorBasemapLayer","key","apiKey","apikey","Error","_createLayer","customUrl","_maplibreGL","_ready","_setupAttribution","setEsriAttribution","sources","stylesheet","allAttributions","Object","keys","forEach","copyrightText","addAttribution","join","attributionUrls","_getAttributionUrls","index","indexOf","_initPane","_asyncAdd","createPane","pointerEvents","zIndex","removeLayer","element","document","getElementsByClassName","vectorAttribution","outerHTML","removeAttribution","addTo","VectorTileLayer","wkid","tileInfo","spatialReference","warn","metadata","sourcesKeys","sourceIndex","source","replace","tiles","minzoom","lods","level","maxzoom","lastSource","layerIndex","layers","layer","layout","sprite","glyphs","formatStyle","getAttribution"],"mappings":"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"}